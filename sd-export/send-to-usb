#! /usr/bin/python3
import os
import shutil
import subprocess
import sys

DEVICE = "/dev/sda1"
MOUNTPOINT = "/tmp/usb"
FILE = sys.argv[1]

if os.path.exists(FILE):
    # mount target not created
    if not os.path.exists(MOUNTPOINT):
        os.makedirs(MOUNTPOINT)

    # check if drive already mounted
    rc = subprocess.call(
        ["mountpoint", MOUNTPOINT], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL
    )
    if rc:
        # drive is not already mounted, so...
        out = subprocess.run(["sudo", "mount", "-o", "uid=1000,gid=1000", DEVICE, MOUNTPOINT])

    rc = subprocess.call(
        ["mountpoint", MOUNTPOINT], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL
    )
    if rc:
        # drive still not mounted
        sys.exit(1)

    # copy files to drive (overwrites existing files) and unmount drive
    shutil.copy(FILE, os.path.join(MOUNTPOINT, os.path.basename(FILE)))

    # sync to ensure the files are fully written before unmounting
    subprocess.run(["sudo", "sync"])

    # finally, unmount the USB device
    subprocess.run(["sudo", "umount", MOUNTPOINT])
